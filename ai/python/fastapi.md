# ä¸»è¦åŒºåˆ«

**FastAPI** å’Œ **Flask** éƒ½æ˜¯ç”¨äºæ„å»º Web åº”ç”¨ç¨‹åºçš„ Python æ¡†æ¶ï¼Œä½†å®ƒä»¬æœ‰ä¸€äº›æ˜¾è‘—çš„å·®å¼‚ï¼Œé€‚åˆä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„ä¸»è¦åŒºåˆ«ï¼š

### 1. **æ¡†æ¶å®šä½ä¸è®¾è®¡ç›®æ ‡**

- **Flask**ï¼šFlask æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å¾®æ¡†æ¶ï¼Œè®¾è®¡ä¸Šéå¸¸çµæ´»ï¼Œå…è®¸å¼€å‘è€…æ ¹æ®éœ€è¦è‡ªç”±åœ°é€‰æ‹©æ‰©å±•åº“å’Œæ¶æ„æ–¹å¼ã€‚é€‚åˆéœ€è¦çµæ´»è‡ªå®šä¹‰çš„ Web åº”ç”¨å’Œå°å‹ã€ç®€å•çš„ API æœåŠ¡ã€‚
- **FastAPI**ï¼šFastAPI ä¸“æ³¨äºå¿«é€Ÿæ„å»ºé«˜æ€§èƒ½çš„ REST APIï¼Œåˆ©ç”¨äº† Python 3.6+ çš„ç±»å‹æ³¨è§£å’Œç°ä»£å¼‚æ­¥ç‰¹æ€§ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯é«˜æ€§èƒ½ã€è‡ªåŠ¨åŒ– API æ–‡æ¡£ç”Ÿæˆå’Œæ•°æ®éªŒè¯ã€‚

### 2. **æ€§èƒ½**

- **FastAPI**ï¼šFastAPI ä½¿ç”¨ **Starlette** å’Œ **Pydantic** ä½œä¸ºåº•å±‚æŠ€æœ¯ï¼Œç»“åˆäº†å¼‚æ­¥ç¼–ç¨‹ï¼ˆ`asyncio`ï¼‰å’Œé«˜æ•ˆçš„ ASGI æ¡†æ¶ï¼Œæ€§èƒ½éå¸¸é«˜ï¼Œæ˜¯æ„å»ºé«˜å¹¶å‘å’Œä½å»¶è¿Ÿåº”ç”¨çš„ä¼˜ç§€é€‰æ‹©ã€‚
- **Flask**ï¼šFlask æ˜¯ WSGI æ¡†æ¶ï¼Œæœ¬è´¨ä¸Šæ˜¯åŒæ­¥çš„ã€‚è™½ç„¶æ”¯æŒæŸäº›å¼‚æ­¥æ‰©å±•ï¼Œä½†å…¶æ€§èƒ½é€šå¸¸ä½äº FastAPIï¼Œæ›´é€‚åˆ I/O å¯†é›†å‹æˆ–ä½å¹¶å‘çš„åº”ç”¨ã€‚

### 3. **å¼‚æ­¥æ”¯æŒ**

- **FastAPI**ï¼šåŸç”Ÿæ”¯æŒå¼‚æ­¥ç¼–ç¨‹ï¼Œå…è®¸ä½¿ç”¨ `async` / `await` ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œé€‚åˆ I/O å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚è°ƒç”¨å¤–éƒ¨ API æˆ–æ•°æ®åº“æ“ä½œï¼‰ï¼Œæ˜¾è‘—æå‡æ€§èƒ½ã€‚
- **Flask**ï¼šFlask åŸç”Ÿä¸æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œä½†å¯ä»¥é€šè¿‡ `gevent`ã€`aiohttp` ç­‰æ‰©å±•åº“è¿›è¡Œæ”¯æŒï¼Œä½†ä½¿ç”¨èµ·æ¥ä¸å¦‚ FastAPI è‡ªç„¶ã€‚

### 4. **ç±»å‹æ³¨è§£ä¸æ•°æ®éªŒè¯**

- **FastAPI**ï¼šæ·±åº¦é›†æˆäº† Python ç±»å‹æ³¨è§£ï¼Œåˆ©ç”¨ Pydantic è¿›è¡Œæ•°æ®éªŒè¯ã€‚å®šä¹‰è¯·æ±‚ä½“ã€è·¯å¾„å‚æ•°ã€æŸ¥è¯¢å‚æ•°æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ç±»å‹æ³¨è§£ï¼Œè‡ªåŠ¨å®Œæˆæ•°æ®éªŒè¯ï¼Œå‡å°‘ä»£ç é‡ã€‚
- **Flask**ï¼šæ²¡æœ‰å†…ç½®æ•°æ®éªŒè¯ï¼Œéœ€è¦é€šè¿‡ Marshmallow æˆ– WTForms ç­‰åº“æ‰‹åŠ¨å®šä¹‰å’ŒéªŒè¯æ•°æ®ï¼Œä»£ç é‡ç›¸å¯¹è¾ƒå¤šã€‚

### 5. **è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£**

- **FastAPI**ï¼šFastAPI è‡ªå¸¦è‡ªåŠ¨ç”Ÿæˆ OpenAPIï¼ˆSwaggerï¼‰å’Œ ReDoc æ–‡æ¡£ã€‚åªéœ€å®šä¹‰è·¯ç”±å’Œ Pydantic æ¨¡å‹ï¼Œå³å¯åœ¨ `/docs` å’Œ `/redoc` è®¿é—®è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£ï¼Œæ–‡æ¡£ä¼šå®æ—¶æ›´æ–°ã€‚
- **Flask**ï¼šFlask ä¸è‡ªå¸¦ API æ–‡æ¡£ç”Ÿæˆï¼Œéœ€è¦é€šè¿‡ Flask-RESTPlusã€Flasgger ç­‰åº“ç”Ÿæˆ Swagger æ–‡æ¡£ï¼Œé…ç½®ç›¸å¯¹å¤æ‚ï¼Œä¸”æ–‡æ¡£ç”Ÿæˆçš„è‡ªåŠ¨åŒ–ç¨‹åº¦è¾ƒä½ã€‚

### 6. **æ‰©å±•æ€§ä¸æ’ä»¶ç”Ÿæ€**

- **Flask**ï¼šç”±äºå†å²æ‚ ä¹…ï¼ŒFlask çš„æ‰©å±•ç”Ÿæ€ä¸°å¯Œï¼Œå¯ä»¥é€šè¿‡ Flask-SQLAlchemyã€Flask-RESTfulã€Flask-JWT ç­‰æ‰©å±•å®ç°ä¸°å¯Œçš„åŠŸèƒ½ï¼Œéå¸¸é€‚åˆå°å‹ã€ä¸­å‹é¡¹ç›®ã€‚
- **FastAPI**ï¼šFastAPI æ˜¯ä¸€ä¸ªæ–°å…´æ¡†æ¶ï¼Œè™½ç„¶æ‰©å±•è¾ƒå°‘ï¼Œä½†å¯ä»¥é›†æˆ Starlette å’Œ Pydantic æ‰©å±•åº“ï¼ŒåŒæ—¶å…¼å®¹ ASGI åº”ç”¨çš„éƒ¨åˆ†ç”Ÿæ€ï¼Œå¦‚ WebSocket å’Œ GraphQLã€‚

### 7. **ä¸Šæ‰‹éš¾æ˜“åº¦**

- **Flask**ï¼šFlask API ç®€å•ã€æ˜“äºç†è§£ï¼Œæ˜¯è®¸å¤šæ–°æ‰‹å­¦ä¹  Web æ¡†æ¶çš„é€‰æ‹©ã€‚æ²¡æœ‰ä¸¥æ ¼çš„ç»“æ„è§„èŒƒï¼Œå¼€å‘è€…å¯ä»¥çµæ´»é€‰æ‹©è‡ªå·±çš„å¼€å‘æ–¹å¼ã€‚
- **FastAPI**ï¼šä½¿ç”¨ Python çš„ç±»å‹æ³¨è§£ï¼Œå­¦ä¹ æ›²çº¿ç¨é™¡ï¼Œä½†å¯¹äºç†Ÿæ‚‰ç±»å‹æ³¨è§£å’Œå¼‚æ­¥ç¼–ç¨‹çš„å¼€å‘è€…æ¥è¯´ï¼ŒFastAPI ä»£ç æ›´åŠ ç®€æ´å’Œæ¸…æ™°ã€‚

### 8. **å…¸å‹åº”ç”¨åœºæ™¯**

- **Flask**ï¼šé€‚åˆæ„å»ºå°å‹ Web åº”ç”¨å’Œä½å¹¶å‘ API é¡¹ç›®ï¼Œé€‚ç”¨äºç®€å•çš„ API æœåŠ¡ã€åŸå‹å¼€å‘æˆ– MVP äº§å“ã€‚
- **FastAPI**ï¼šé€‚åˆæ„å»ºé«˜å¹¶å‘ã€é«˜æ€§èƒ½çš„ API å¾®æœåŠ¡ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠæ•°æ®éªŒè¯ã€å¤æ‚è¯·æ±‚ä½“å¤„ç†çš„åœºæ™¯ï¼Œå¦‚æœºå™¨å­¦ä¹ æ¨¡å‹æœåŠ¡ã€å®æ—¶æ•°æ®å¤„ç†æ¥å£ç­‰ã€‚

### æ€»ç»“

- **é€‰æ‹© Flask**ï¼šå¦‚æœé¡¹ç›®éœ€æ±‚ç®€å•ã€å¹¶å‘é‡ä¸é«˜ï¼Œä¸”å›¢é˜Ÿç†Ÿæ‚‰ä¼ ç»ŸåŒæ­¥ç¼–ç¨‹ï¼Œå¯ä»¥é€‰æ‹© Flaskã€‚
- **é€‰æ‹© FastAPI**ï¼šå¦‚æœé¡¹ç›®éœ€è¦é«˜æ€§èƒ½å’Œå¼‚æ­¥æ”¯æŒã€å¯¹ç±»å‹æ³¨è§£å’Œæ•°æ®éªŒè¯éœ€æ±‚å¼ºçƒˆï¼Œå¹¶ä¸”å¸Œæœ›è‡ªåŠ¨åŒ– API æ–‡æ¡£ï¼Œé‚£ä¹ˆ FastAPI æ˜¯æ›´é€‚åˆçš„é€‰æ‹©ã€‚



# ç‰¹æ€§ä»‹ç»

## async

**Python é‡Œçš„ `async/await` ä½¿ç”¨æ–¹å¼**ç³»ç»Ÿåœ°è®²æ¸…æ¥šã€‚

------

### 1. ä»€ä¹ˆæ˜¯ `async/await`

- `async def` å®šä¹‰çš„æ˜¯ **åç¨‹å‡½æ•°**ï¼Œè°ƒç”¨æ—¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª **åç¨‹å¯¹è±¡**ã€‚
- `await` çš„ä½œç”¨æ˜¯ **æŒ‚èµ·å½“å‰åç¨‹**ï¼Œç­‰å¾…å¦ä¸€ä¸ªåç¨‹å®Œæˆï¼Œå¹¶æŠŠæ§åˆ¶æƒäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯ã€‚
- å¿…é¡»è¿è¡Œåœ¨ä¸€ä¸ª **äº‹ä»¶å¾ªç¯** ä¸­ï¼Œé€šå¸¸ç”± `asyncio.run()` æˆ– Web æ¡†æ¶ï¼ˆFastAPI/Starlette/ASGI æœåŠ¡å™¨ï¼‰å¸®ä½ ç®¡ç†ã€‚

------

### 2. åŸºæœ¬ç”¨æ³•

```
import asyncio

async def task(name, delay):
    print(f"{name} å¼€å§‹")
    await asyncio.sleep(delay)   # éé˜»å¡ç­‰å¾…
    print(f"{name} å®Œæˆ")
    return name

async def main():
    # å¹¶å‘è¿è¡Œå¤šä¸ªåç¨‹
    results = await asyncio.gather(
        task("ä»»åŠ¡1", 2),
        task("ä»»åŠ¡2", 3),
        task("ä»»åŠ¡3", 1),
    )
    print("ç»“æœ:", results)

# å¯åŠ¨äº‹ä»¶å¾ªç¯
asyncio.run(main())
```

**è¾“å‡ºï¼ˆå¤§çº¦ 3 ç§’å®Œæˆï¼‰ï¼š**

```
ä»»åŠ¡1 å¼€å§‹
ä»»åŠ¡2 å¼€å§‹
ä»»åŠ¡3 å¼€å§‹
ä»»åŠ¡3 å®Œæˆ
ä»»åŠ¡1 å®Œæˆ
ä»»åŠ¡2 å®Œæˆ
ç»“æœ: ['ä»»åŠ¡1', 'ä»»åŠ¡2', 'ä»»åŠ¡3']
```

ğŸ‘‰ ç‰¹ç‚¹ï¼šè™½ç„¶æœ‰ 3 ä¸ªè€—æ—¶æ“ä½œï¼Œä½†æ€»æ—¶é—´åªå–å†³äºæœ€é•¿çš„é‚£ä¸ªï¼ˆ3 ç§’ï¼‰ï¼Œè€Œä¸æ˜¯ 2+3+1=6 ç§’ã€‚

------

### 3. å¸¸è§åœºæ™¯

#### (1) å¹¶å‘ I/O æ“ä½œ

é€‚åˆç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“è®¿é—®ç­‰ I/O å¯†é›†å‹ä»»åŠ¡ã€‚

```
import httpx, asyncio

async def fetch(url):
    async with httpx.AsyncClient() as client:
        resp = await client.get(url)
        return resp.text[:50]

async def main():
    urls = ["https://www.python.org", "https://www.fastapi.tiangolo.com"]
    results = await asyncio.gather(*(fetch(u) for u in urls))
    print(results)

asyncio.run(main())
```

------

#### (2) åœ¨ FastAPI é‡Œ

FastAPIï¼ˆASGI æ¡†æ¶ï¼‰å¤©ç„¶æ”¯æŒ `async` è·¯ç”±ï¼š

```
from fastapi import FastAPI
import asyncio

app = FastAPI()

@app.get("/demo")
async def demo():
    await asyncio.sleep(2)   # æ¨¡æ‹Ÿå¼‚æ­¥ I/O
    return {"msg": "ok"}
```

ğŸ‘‰ è¯·æ±‚ä¼šåœ¨ **2 ç§’åè¿”å›**ï¼Œä½†è¿™ 2 ç§’æœŸé—´ï¼ŒæœåŠ¡å™¨çº¿ç¨‹è¿˜èƒ½å¤„ç†å…¶ä»–è¯·æ±‚ã€‚

------

#### (3) åœ¨åŒæ­¥ä»£ç é‡Œè°ƒç”¨åç¨‹ - **åä½œå¼å¹¶å‘**ï¼ˆconcurrencyï¼‰ 

æœ‰æ—¶å€™ä½ åœ¨åŒæ­¥å‡½æ•°é‡Œæƒ³è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼Œå¯ä»¥ç”¨ `asyncio.run` æˆ– `asyncio.to_thread`ï¼š

```
import asyncio

async def async_task():
    await asyncio.sleep(1)
    return "done"

def sync_func():
    result = asyncio.run(async_task())
    print(result)

sync_func()
```

------

### 4. æ³¨æ„ç‚¹

- `async/await` **ä¸ä¼š**æ–°å¼€çº¿ç¨‹ï¼Œè€Œæ˜¯åŸºäºäº‹ä»¶å¾ªç¯è°ƒåº¦ã€‚
- **ä¸ä¼šæå‰è¿”å›ç»“æœ**ï¼Œé™¤éä½ è‡ªå·±å†™åå°ä»»åŠ¡ï¼ˆå¦‚ `BackgroundTasks`ã€çº¿ç¨‹æ± ï¼‰ã€‚
- å¦‚æœè°ƒç”¨é˜»å¡åº“ï¼ˆå¦‚ `requests`ã€`time.sleep`ï¼‰ï¼Œä¼šå¡ä½äº‹ä»¶å¾ªç¯ï¼Œéœ€è¦ç”¨ `await asyncio.to_thread(...)` æˆ–æ”¹ç”¨å¼‚æ­¥åº“ï¼ˆå¦‚ `httpx`ã€`asyncpg`ï¼‰ã€‚

------

ğŸ”‘ ä¸€å¥è¯æ€»ç»“ï¼š
 **Python é‡Œçš„ `async/await` æ˜¯äº‹ä»¶å¾ªç¯é‡Œçš„åç¨‹æœºåˆ¶ï¼Œèƒ½è®©ç­‰å¾… I/O çš„æ—¶å€™ä¸é˜»å¡çº¿ç¨‹ï¼Œå®ç°é«˜å¹¶å‘ I/Oã€‚**
 ä½†å®ƒå’Œâ€œåå°çº¿ç¨‹å¼‚æ­¥â€ä¸ä¸€æ ·ï¼Œé™¤éä½ æ˜¾å¼æŠŠä»»åŠ¡ä¸¢åˆ°çº¿ç¨‹æ± æˆ–ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦åˆ™å“åº”è¿˜æ˜¯è¦ç­‰é€»è¾‘æ‰§è¡Œå®Œæ‰ä¼šè¿”å›ã€‚

------

è¦ä¸è¦æˆ‘ç»™ä½ å†™ä¸€ä¸ª **â€œé˜»å¡ vs async/awaitâ€çš„å¯¹æ¯”å°å®éªŒ**ï¼ˆåŒæ · 10 ä¸ªè¯·æ±‚ï¼Œåˆ†åˆ«ç”¨ `time.sleep` å’Œ `await asyncio.sleep`ï¼‰ï¼Œè¿™æ ·ä½ ä¸€è·‘å°±èƒ½ç›´è§‚æ„Ÿå—åˆ°å·®åˆ«ï¼Ÿ

## å¼‚æ­¥å¤šçº¿ç¨‹

### Flask

```
executor = ThreadPoolExecutor(max_workers=1)


def scheduled_task(app):
    '''
    å®šæ—¶ä»»åŠ¡ - ä½¿ç”¨çº¿ç¨‹æ± å¹¶å¢åŠ è¶…æ—¶è®¾ç½®
    '''
    future = executor.submit(_recognize_queue_task, app)
    
    try:
        result = future.result(timeout=60)  # è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´ä¸º 30 ç§’
    except TimeoutError:
        print("Task took too long, terminating...")
```

### FastAPI

```
import time
import asyncio

def blocking_task(n):
    print(f"çº¿ç¨‹ä»»åŠ¡{n}å¼€å§‹")
    time.sleep(1)  # é˜»å¡
    print(f"çº¿ç¨‹ä»»åŠ¡{n}ç»“æŸ")
    return n

async def main():
    results = await asyncio.gather(*(asyncio.to_thread(blocking_task, i) for i in range(5)))
    print("ç»“æœ:", results)

asyncio.run(main())
```

# å…¶ä»–é—®é¢˜

## ç¦ç”¨è‡ªåŠ¨é‡å¯

```
	# uvicorn.run(
	# 	"main:app",
	# 	host="0.0.0.0",
	# 	port=8001, # lsof -i: $port|awk '{if(NR>=2) print $2}'|xargs kill
	# 	# reload=True, # ç›®å½•é‡Œçš„æ–‡ä»¶æœ‰æ”¹åŠ¨,å°±è‡ªåŠ¨é‡å¯æœåŠ¡ã€‚
	# 	# log_level="debug",
	# )
	config = uvicorn.Config("main:app", host="0.0.0.0", port=8001)
	server = uvicorn.Server(config)
	import asyncio
	
	asyncio.get_event_loop().run_until_complete(server.serve())
```

â—PyCharm çš„è°ƒè¯•å™¨ + Python 3.12 + uvicorn çš„ asyncio patch å†²çª

å…·ä½“æ˜¯è¿™å¥é”™è¯¯ï¼š

TypeError: _patch_asyncio.<locals>.run() got an unexpected keyword argument 'loop_factory'


è¿™å°±æ˜¯ PyCharm debugger å¯¹ asyncio çš„ monkey patchï¼ˆ_patch_asyncioï¼‰å’Œ Uvicorn çš„ asyncio.run() å†²çªé€ æˆçš„ã€‚
